{% extends "base.html" %}

{% block title %}ä»ªè¡¨ç›˜ - Trend-Autostop{% endblock %}

{% block page_title %}ä»ªè¡¨ç›˜{% endblock %}

{% block content %}
<!-- Stats Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon bullish">ğŸ“ˆ</div>
        <div class="stat-info">
            <span class="stat-value">{{ stats.total_positions }}</span>
            <span class="stat-label">æŒä»“æ•°é‡</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon active">âš¡</div>
        <div class="stat-info">
            <span class="stat-value">{{ stats.active_tasks }}</span>
            <span class="stat-label">æ´»è·ƒä»»åŠ¡</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon paused">â¸ï¸</div>
        <div class="stat-info">
            <span class="stat-value">{{ stats.paused_tasks }}</span>
            <span class="stat-label">æš‚åœä»»åŠ¡</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon {% if stats.total_pnl >= 0 %}bullish{% else %}bearish{% endif %}">
            {% if stats.total_pnl >= 0 %}ğŸ’°{% else %}ğŸ“‰{% endif %}
        </div>
        <div class="stat-info">
            <span class="stat-value {% if stats.total_pnl >= 0 %}profit{% else %}loss{% endif %}">
                {{ "%.2f"|format(stats.total_pnl) }} USDT
            </span>
            <span class="stat-label">æœªå®ç°ç›ˆäº</span>
        </div>
    </div>
</div>

<!-- Unmanaged Positions -->
<section class="card">
    <div class="card-header">
        <h2>æœªæ‰˜ç®¡ä»“ä½</h2>
        <button class="btn btn-ghost btn-sm" onclick="refreshUnmanagedPositions()">
            <span>ğŸ”„</span> åˆ·æ–°
        </button>
    </div>
    <div class="card-body" id="unmanaged-positions-container">
        <div class="loading-state">
            <p>åŠ è½½ä¸­...</p>
        </div>
    </div>
</section>

<!-- Managed Positions Table -->
<section class="card">
    <div class="card-header">
        <h2>æ™ºèƒ½æ­¢æŸä»“ä½</h2>
        <a href="/positions" class="btn btn-primary btn-sm">
            <span>â•</span> å¼€å¯æ­¢æŸ
        </a>
    </div>
    <div class="card-body">
        {% if configs %}
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>äº¤æ˜“å¯¹</th>
                        <th>æ–¹å‘</th>
                        <th>æ—¶é—´å‘¨æœŸ</th>
                        <th>æ­¢æŸä½</th>
                        <th>SL Offset</th>
                        <th>å»¶è¿ŸKçº¿</th>
                        <th>çŠ¶æ€</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for config in configs %}
                    <tr>
                        <td class="symbol">{{ config.symbol }}</td>
                        <td>
                            <span class="badge {% if config.side == 'long' %}badge-success{% else %}badge-danger{% endif %}">
                                {{ config.side|upper }}
                            </span>
                        </td>
                        <td class="mono">{{ config.timeframe }}</td>
                        <td class="mono">
                            {% if config.current_stop_price %}
                            {{ "%.4f"|format(config.current_stop_price) }}
                            {% else %}
                            <span class="text-muted">--</span>
                            {% endif %}
                        </td>
                        <td class="mono">{{ config.sl_offset }}</td>
                        <td class="mono">{{ config.bars_since_open }}/{{ config.delay_bars }}</td>
                        <td>
                            <span class="status-badge status-{{ config.status }}">
                                {% if config.status == 'active' %}è¿è¡Œä¸­
                                {% elif config.status == 'paused' %}å·²æš‚åœ
                                {% else %}å·²åœæ­¢{% endif %}
                            </span>
                        </td>
                        <td class="actions">
                            {% if config.status == 'active' %}
                            <button class="btn btn-icon" onclick="pauseConfig({{ config.id }})" title="æš‚åœ">â¸ï¸</button>
                            {% else %}
                            <button class="btn btn-icon" onclick="resumeConfig({{ config.id }})" title="æ¢å¤">â–¶ï¸</button>
                            {% endif %}
                            <button class="btn btn-icon" onclick="editConfig({{ config.id }})" title="ç¼–è¾‘">âœï¸</button>
                            <button class="btn btn-icon danger" onclick="deleteConfig({{ config.id }})" title="åˆ é™¤">ğŸ—‘ï¸</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">ğŸ›¡ï¸</div>
            <p>æš‚æ— æ™ºèƒ½æ­¢æŸä»“ä½</p>
            <a href="/positions" class="btn btn-primary">å¼€å¯ç¬¬ä¸€ä¸ªæ™ºèƒ½æ­¢æŸ</a>
        </div>
        {% endif %}
    </div>
</section>

<!-- Recent Logs -->
<section class="card">
    <div class="card-header">
        <h2>æœ€è¿‘æ“ä½œ</h2>
        <a href="/logs" class="btn btn-ghost btn-sm">æŸ¥çœ‹å…¨éƒ¨</a>
    </div>
    <div class="card-body">
        {% if logs %}
        <div class="log-list">
            {% for log in logs[:10] %}
            <div class="log-item {% if not log.success %}error{% endif %}">
                <span class="log-time">{{ log.created_at.strftime('%m-%d %H:%M') }}</span>
                <span class="log-action">{{ log.action }}</span>
                <span class="log-symbol">{{ log.symbol or '--' }}</span>
                <span class="log-message">{{ log.message }}</span>
                {% if log.old_value and log.new_value %}
                <span class="log-values">
                    {{ "%.4f"|format(log.old_value) }} â†’ {{ "%.4f"|format(log.new_value) }}
                </span>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state small">
            <p>æš‚æ— æ“ä½œè®°å½•</p>
        </div>
        {% endif %}
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
const credentialIds = {{ credentials|map(attribute='id')|list|tojson }};

async function loadUnmanagedPositions() {
    const container = document.getElementById('unmanaged-positions-container');
    
    if (credentialIds.length === 0) {
        container.innerHTML = `
            <div class="empty-state small">
                <p>è¯·å…ˆåœ¨è®¾ç½®ä¸­æ·»åŠ APIè´¦æˆ·</p>
                <a href="/settings" class="btn btn-ghost btn-sm">å‰å¾€è®¾ç½®</a>
            </div>
        `;
        return;
    }
    
    container.innerHTML = '<div class="loading-state"><p>åŠ è½½ä¸­...</p></div>';
    
    let allUnmanaged = [];
    
    for (const credId of credentialIds) {
        try {
            const res = await fetch(`/api/credentials/${credId}/unmanaged-positions`);
            if (res.ok) {
                const positions = await res.json();
                positions.forEach(p => {
                    p.credential_id = credId;
                });
                allUnmanaged = allUnmanaged.concat(positions);
            }
        } catch (err) {
            console.error('Failed to load positions for credential', credId, err);
        }
    }
    
    if (allUnmanaged.length === 0) {
        container.innerHTML = `
            <div class="empty-state small">
                <div class="empty-icon">âœ…</div>
                <p>æ‰€æœ‰ä»“ä½å‡å·²æ‰˜ç®¡</p>
            </div>
        `;
        return;
    }
    
    let tableHtml = `
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>äº¤æ˜“å¯¹</th>
                        <th>æ–¹å‘</th>
                        <th>æ•°é‡</th>
                        <th>å¼€ä»“ä»·</th>
                        <th>æœªå®ç°ç›ˆäº</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    allUnmanaged.forEach(pos => {
        const sideClass = pos.side === 'long' ? 'badge-success' : 'badge-danger';
        const sideText = pos.side === 'long' ? 'LONG' : 'SHORT';
        const pnlClass = pos.unrealized_pnl >= 0 ? 'profit' : 'loss';
        
        tableHtml += `
            <tr>
                <td class="symbol">${pos.symbol}</td>
                <td><span class="badge ${sideClass}">${sideText}</span></td>
                <td class="mono">${pos.size}</td>
                <td class="mono">${pos.entry_price.toFixed(4)}</td>
                <td class="mono ${pnlClass}">${pos.unrealized_pnl.toFixed(2)} USDT</td>
                <td class="actions">
                    <a href="/positions?symbol=${encodeURIComponent(pos.symbol)}&side=${pos.side}&credential_id=${pos.credential_id}" 
                       class="btn btn-primary btn-sm">å¼€å¯æ­¢æŸ</a>
                </td>
            </tr>
        `;
    });
    
    tableHtml += '</tbody></table></div>';
    container.innerHTML = tableHtml;
}

function refreshUnmanagedPositions() {
    loadUnmanagedPositions();
    showToast('æ­£åœ¨åˆ·æ–°ä»“ä½...', 'info');
}

// Load on page init
document.addEventListener('DOMContentLoaded', loadUnmanagedPositions);

async function pauseConfig(id) {
    await fetch(`/api/configs/${id}/pause`, { method: 'POST' });
    showToast('ä»»åŠ¡å·²æš‚åœ', 'success');
    location.reload();
}

async function resumeConfig(id) {
    await fetch(`/api/configs/${id}/resume`, { method: 'POST' });
    showToast('ä»»åŠ¡å·²æ¢å¤', 'success');
    location.reload();
}

async function deleteConfig(id) {
    if (!confirm('ç¡®å®šå…³é—­æ­¤æ™ºèƒ½æ­¢æŸï¼Ÿ')) return;
    await fetch(`/api/configs/${id}`, { method: 'DELETE' });
    showToast('æ™ºèƒ½æ­¢æŸå·²å…³é—­', 'success');
    location.reload();
}

function editConfig(id) {
    window.location.href = `/positions?edit=${id}`;
}
</script>
{% endblock %}


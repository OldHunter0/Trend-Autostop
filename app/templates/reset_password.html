{% extends "auth_base.html" %}

{% block title %}é‡ç½®å¯†ç  - Trend-Autostop{% endblock %}

{% block content %}
<div class="auth-card">
    <h2 class="auth-title">è®¾ç½®æ–°å¯†ç </h2>
    
    {% if error %}
    <div class="alert alert-error">{{ error }}</div>
    {% endif %}
    
    <form id="reset-form">
        <input type="hidden" id="token" value="{{ token }}">
        
        <div class="form-group">
            <label class="form-label" for="password">æ–°å¯†ç </label>
            <div class="password-toggle">
                <input 
                    type="password" 
                    id="password" 
                    name="password" 
                    class="form-input" 
                    placeholder="è‡³å°‘8ä½å­—ç¬¦"
                    required
                    minlength="8"
                    autocomplete="new-password"
                >
                <button type="button" class="toggle-btn">ğŸ‘ï¸</button>
            </div>
            <p class="form-hint">å¯†ç è‡³å°‘éœ€è¦8ä¸ªå­—ç¬¦</p>
        </div>
        
        <div class="form-group">
            <label class="form-label" for="confirm-password">ç¡®è®¤æ–°å¯†ç </label>
            <div class="password-toggle">
                <input 
                    type="password" 
                    id="confirm-password" 
                    name="confirm_password" 
                    class="form-input" 
                    placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç "
                    required
                    autocomplete="new-password"
                >
                <button type="button" class="toggle-btn">ğŸ‘ï¸</button>
            </div>
        </div>
        
        <button type="submit" class="btn btn-primary">
            <span class="btn-text">é‡ç½®å¯†ç </span>
            <span class="loading"></span>
        </button>
    </form>
    
    <div class="auth-footer">
        <p><a href="/auth/login">è¿”å›ç™»å½•</a></p>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.getElementById('reset-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirm-password').value;
    const token = document.getElementById('token').value;
    
    if (password !== confirmPassword) {
        showAlert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'error');
        return;
    }
    
    if (!token) {
        showAlert('æ— æ•ˆçš„é‡ç½®é“¾æ¥', 'error');
        return;
    }
    
    const btn = this.querySelector('button[type="submit"]');
    btn.classList.add('loading-state');
    btn.disabled = true;
    
    try {
        const response = await fetch('/api/auth/reset-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                token: token,
                new_password: password
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            window.location.href = '/auth/login?message=' + encodeURIComponent('å¯†ç å·²é‡ç½®ï¼Œè¯·ä½¿ç”¨æ–°å¯†ç ç™»å½•ã€‚');
        } else {
            showAlert(data.detail || 'é‡ç½®å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        }
    } catch (error) {
        console.error('Reset password error:', error);
        showAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
    } finally {
        btn.classList.remove('loading-state');
        btn.disabled = false;
    }
});

function showAlert(message, type) {
    const existingAlert = document.querySelector('.auth-card .alert');
    if (existingAlert) {
        existingAlert.remove();
    }
    
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type}`;
    alertDiv.textContent = message;
    
    const form = document.getElementById('reset-form');
    form.insertBefore(alertDiv, form.firstChild);
}
</script>
{% endblock %}


{% extends "base.html" %}

{% block title %}è®¾ç½® - Trend-Autostop{% endblock %}

{% block page_title %}è®¾ç½®{% endblock %}

{% block content %}
<div class="content-split">
    <!-- Add Credential Form -->
    <section class="card form-card">
        <div class="card-header">
            <h2>æ·»åŠ  API è´¦æˆ·</h2>
        </div>
        <div class="card-body">
            <form id="credential-form" onsubmit="submitCredential(event)">
                <div class="form-group">
                    <label for="cred-name">è´¦æˆ·åç§° <span class="required">*</span></label>
                    <input type="text" id="cred-name" name="name" placeholder="ä¾‹å¦‚: Binance Main" required>
                </div>
                
                <div class="form-group">
                    <label for="cred-exchange">äº¤æ˜“æ‰€ <span class="required">*</span></label>
                    <select id="cred-exchange" name="exchange" required>
                        <option value="binance">Binance</option>
                        <option value="okx">OKX</option>
                        <option value="bybit">Bybit</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="cred-api-key">API Key <span class="required">*</span></label>
                    <input type="password" id="cred-api-key" name="api_key" required>
                </div>
                
                <div class="form-group">
                    <label for="cred-api-secret">API Secret <span class="required">*</span></label>
                    <input type="password" id="cred-api-secret" name="api_secret" required>
                </div>
                
                <div class="form-group checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="cred-testnet" name="is_testnet">
                        <span>æµ‹è¯•ç½‘ (Testnet)</span>
                    </label>
                </div>
                
                <div class="security-notice">
                    <span class="icon">ğŸ”’</span>
                    <div>
                        <strong>å®‰å…¨æç¤º</strong>
                        <p>APIå¯†é’¥å°†ä½¿ç”¨AES-256åŠ å¯†å­˜å‚¨ã€‚è¯·ç¡®ä¿APIæƒé™<strong>ä»…å¼€å¯è¯»å–å’Œäº¤æ˜“</strong>ï¼Œ<strong>ç¦ç”¨æç°</strong>æƒé™ã€‚</p>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">æ·»åŠ è´¦æˆ·</button>
                </div>
            </form>
        </div>
    </section>
    
    <!-- Credentials List -->
    <section class="card">
        <div class="card-header">
            <h2>å·²ä¿å­˜è´¦æˆ·</h2>
        </div>
        <div class="card-body">
            {% if credentials %}
            <div class="credential-list">
                {% for cred in credentials %}
                <div class="credential-card">
                    <div class="credential-info">
                        <span class="credential-name">{{ cred.name }}</span>
                        <span class="credential-exchange">{{ cred.exchange|upper }}</span>
                        {% if cred.is_testnet %}
                        <span class="badge badge-warning">æµ‹è¯•ç½‘</span>
                        {% endif %}
                    </div>
                    <div class="credential-meta">
                        <span>åˆ›å»ºäº {{ cred.created_at.strftime('%Y-%m-%d') }}</span>
                    </div>
                    <div class="credential-actions">
                        <button class="btn btn-sm btn-danger" onclick="deleteCredential({{ cred.id }}, '{{ cred.name }}')">
                            åˆ é™¤
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-icon">ğŸ”‘</div>
                <p>æš‚æ— ä¿å­˜çš„APIè´¦æˆ·</p>
            </div>
            {% endif %}
        </div>
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function submitCredential(e) {
    e.preventDefault();
    const form = e.target;
    
    const data = {
        name: form.name.value,
        exchange: form.exchange.value,
        api_key: form.api_key.value,
        api_secret: form.api_secret.value,
        is_testnet: form.is_testnet.checked
    };
    
    try {
        const res = await fetch('/api/credentials', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (!res.ok) throw new Error('Failed to save');
        
        showToast('è´¦æˆ·å·²æ·»åŠ ', 'success');
        form.reset();
        location.reload();
    } catch (err) {
        showToast('ä¿å­˜å¤±è´¥: ' + err.message, 'error');
    }
}

async function deleteCredential(id, name) {
    if (!confirm(`ç¡®å®šåˆ é™¤è´¦æˆ· "${name}"ï¼Ÿç›¸å…³çš„æ‰˜ç®¡é…ç½®ä¹Ÿå°†æ— æ³•ä½¿ç”¨ã€‚`)) return;
    
    try {
        await fetch(`/api/credentials/${id}`, { method: 'DELETE' });
        showToast('è´¦æˆ·å·²åˆ é™¤', 'success');
        location.reload();
    } catch (err) {
        showToast('åˆ é™¤å¤±è´¥', 'error');
    }
}
</script>
{% endblock %}


{% extends "auth_base.html" %}

{% block title %}æ³¨å†Œ - Trend-Autostop{% endblock %}

{% block content %}
<div class="auth-card">
    <h2 class="auth-title">åˆ›å»ºè´¦æˆ·</h2>
    
    {% if error %}
    <div class="alert alert-error">{{ error }}</div>
    {% endif %}
    
    <form id="register-form">
        <div class="form-group">
            <label class="form-label" for="email">é‚®ç®±åœ°å€</label>
            <input 
                type="email" 
                id="email" 
                name="email" 
                class="form-input" 
                placeholder="your@email.com"
                required
                autocomplete="email"
            >
        </div>
        
        <div class="form-group">
            <label class="form-label" for="username">ç”¨æˆ·å <span style="color: var(--text-muted)">(å¯é€‰)</span></label>
            <input 
                type="text" 
                id="username" 
                name="username" 
                class="form-input" 
                placeholder="æ‚¨çš„æ˜µç§°"
                autocomplete="username"
            >
        </div>
        
        <div class="form-group">
            <label class="form-label" for="password">å¯†ç </label>
            <div class="password-toggle">
                <input 
                    type="password" 
                    id="password" 
                    name="password" 
                    class="form-input" 
                    placeholder="è‡³å°‘8ä½å­—ç¬¦"
                    required
                    minlength="8"
                    autocomplete="new-password"
                >
                <button type="button" class="toggle-btn">ğŸ‘ï¸</button>
            </div>
            <p class="form-hint">å¯†ç è‡³å°‘éœ€è¦8ä¸ªå­—ç¬¦</p>
        </div>
        
        <div class="form-group">
            <label class="form-label" for="confirm-password">ç¡®è®¤å¯†ç </label>
            <div class="password-toggle">
                <input 
                    type="password" 
                    id="confirm-password" 
                    name="confirm_password" 
                    class="form-input" 
                    placeholder="å†æ¬¡è¾“å…¥å¯†ç "
                    required
                    autocomplete="new-password"
                >
                <button type="button" class="toggle-btn">ğŸ‘ï¸</button>
            </div>
        </div>
        
        <button type="submit" class="btn btn-primary">
            <span class="btn-text">åˆ›å»ºè´¦æˆ·</span>
            <span class="loading"></span>
        </button>
    </form>
    
    <div class="auth-footer">
        <p>å·²æœ‰è´¦æˆ·ï¼Ÿ<a href="/auth/login">ç«‹å³ç™»å½•</a></p>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.getElementById('register-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirm-password').value;
    
    if (password !== confirmPassword) {
        showAlert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'error');
        return;
    }
    
    const btn = this.querySelector('button[type="submit"]');
    btn.classList.add('loading-state');
    btn.disabled = true;
    
    const formData = {
        email: document.getElementById('email').value,
        password: password,
        username: document.getElementById('username').value || null
    };
    
    try {
        const response = await fetch('/api/auth/register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // Redirect to login with success message
            window.location.href = '/auth/login?message=' + encodeURIComponent('æ³¨å†ŒæˆåŠŸï¼è¯·æ£€æŸ¥é‚®ç®±éªŒè¯æ‚¨çš„è´¦æˆ·ã€‚');
        } else {
            showAlert(data.detail || 'æ³¨å†Œå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        }
    } catch (error) {
        console.error('Register error:', error);
        showAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
    } finally {
        btn.classList.remove('loading-state');
        btn.disabled = false;
    }
});

function showAlert(message, type) {
    const existingAlert = document.querySelector('.auth-card .alert');
    if (existingAlert) {
        existingAlert.remove();
    }
    
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type}`;
    alertDiv.textContent = message;
    
    const form = document.getElementById('register-form');
    form.insertBefore(alertDiv, form.firstChild);
}
</script>
{% endblock %}


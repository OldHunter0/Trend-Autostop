{% extends "base.html" %}

{% block title %}ç®¡ç†åå° - Trend-Autostop{% endblock %}

{% block page_title %}ç®¡ç†åå°{% endblock %}

{% block content %}
<!-- Stats Overview -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon active">ğŸ‘¥</div>
        <div class="stat-info">
            <span class="stat-value" id="total-users">-</span>
            <span class="stat-label">æ€»ç”¨æˆ·æ•°</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon bullish">âœ“</div>
        <div class="stat-info">
            <span class="stat-value" id="verified-users">-</span>
            <span class="stat-label">å·²éªŒè¯ç”¨æˆ·</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon active">ğŸ“Š</div>
        <div class="stat-info">
            <span class="stat-value" id="active-configs">-</span>
            <span class="stat-label">è¿è¡Œä¸­ç­–ç•¥</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon paused">ğŸ”</div>
        <div class="stat-info">
            <span class="stat-value" id="recent-logins">-</span>
            <span class="stat-label">24h ç™»å½•æ¬¡æ•°</span>
        </div>
    </div>
</div>

<!-- Users Section -->
<div class="card">
    <div class="card-header">
        <h2>ğŸ‘¥ ç”¨æˆ·ç®¡ç†</h2>
        <button class="btn btn-ghost btn-sm" onclick="loadUsers()">åˆ·æ–°</button>
    </div>
    <div class="table-responsive">
        <table class="data-table" id="users-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>é‚®ç®±</th>
                    <th>ç”¨æˆ·å</th>
                    <th>è§’è‰²</th>
                    <th>çŠ¶æ€</th>
                    <th>é‚®ç®±éªŒè¯</th>
                    <th>æœ€åç™»å½•</th>
                    <th>æ³¨å†Œæ—¶é—´</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="users-tbody">
                <tr>
                    <td colspan="9" class="loading-state">
                        <p>åŠ è½½ä¸­...</p>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Strategies Overview -->
<div class="card">
    <div class="card-header">
        <h2>ğŸ“Š ç­–ç•¥è¿è¡Œæ¦‚è§ˆ</h2>
        <button class="btn btn-ghost btn-sm" onclick="loadStrategies()">åˆ·æ–°</button>
    </div>
    <div class="table-responsive">
        <table class="data-table" id="strategies-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>äº¤æ˜“å¯¹</th>
                    <th>æ–¹å‘</th>
                    <th>çŠ¶æ€</th>
                    <th>å‘¨æœŸ</th>
                    <th>å½“å‰æ­¢æŸ</th>
                    <th>æœ€åæ£€æŸ¥</th>
                    <th>æ›´æ–°æ—¶é—´</th>
                </tr>
            </thead>
            <tbody id="strategies-tbody">
                <tr>
                    <td colspan="8" class="loading-state">
                        <p>åŠ è½½ä¸­...</p>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Audit Logs -->
<div class="card">
    <div class="card-header">
        <h2>ğŸ“‹ å®¡è®¡æ—¥å¿—</h2>
        <div style="display: flex; gap: 0.5rem;">
            <select id="audit-action-filter" class="form-control" style="width: auto; padding: 0.375rem 0.75rem; font-size: 0.8rem;">
                <option value="">å…¨éƒ¨æ“ä½œ</option>
                <option value="login">ç™»å½•</option>
                <option value="logout">ç™»å‡º</option>
                <option value="register">æ³¨å†Œ</option>
                <option value="email_verified">é‚®ç®±éªŒè¯</option>
                <option value="password_reset">å¯†ç é‡ç½®</option>
                <option value="bind_api_key">ç»‘å®š API Key</option>
                <option value="unbind_api_key">è§£ç»‘ API Key</option>
            </select>
            <button class="btn btn-ghost btn-sm" onclick="loadAuditLogs()">åˆ·æ–°</button>
        </div>
    </div>
    <div class="table-responsive">
        <table class="data-table" id="audit-table">
            <thead>
                <tr>
                    <th>æ—¶é—´</th>
                    <th>ç”¨æˆ·ID</th>
                    <th>æ“ä½œ</th>
                    <th>èµ„æºç±»å‹</th>
                    <th>èµ„æºID</th>
                    <th>IPåœ°å€</th>
                    <th>çŠ¶æ€</th>
                </tr>
            </thead>
            <tbody id="audit-tbody">
                <tr>
                    <td colspan="7" class="loading-state">
                        <p>åŠ è½½ä¸­...</p>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Load admin stats
async function loadStats() {
    try {
        const response = await fetch('/api/admin/stats');
        if (response.ok) {
            const data = await response.json();
            document.getElementById('total-users').textContent = data.users.total;
            document.getElementById('verified-users').textContent = data.users.verified;
            document.getElementById('active-configs').textContent = data.trading.active_configs;
            document.getElementById('recent-logins').textContent = data.health.recent_logins_24h;
        }
    } catch (error) {
        console.error('Failed to load stats:', error);
    }
}

// Load users
async function loadUsers() {
    const tbody = document.getElementById('users-tbody');
    tbody.innerHTML = '<tr><td colspan="9" class="loading-state"><p>åŠ è½½ä¸­...</p></td></tr>';
    
    try {
        const response = await fetch('/api/admin/users');
        if (response.ok) {
            const users = await response.json();
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="empty-state small"><p>æš‚æ— ç”¨æˆ·</p></td></tr>';
                return;
            }
            
            tbody.innerHTML = users.map(user => `
                <tr>
                    <td class="mono">${user.id}</td>
                    <td>${user.email}</td>
                    <td>${user.username || '-'}</td>
                    <td><span class="badge ${user.role === 'admin' ? 'badge-warning' : 'badge-success'}">${user.role}</span></td>
                    <td><span class="status-badge ${user.is_active ? 'status-active' : 'status-stopped'}">${user.is_active ? 'æ´»è·ƒ' : 'ç¦ç”¨'}</span></td>
                    <td><span class="status-dot ${user.is_email_verified ? 'success' : 'error'}"></span></td>
                    <td class="mono text-muted">${user.last_login_at ? formatTime(user.last_login_at) : '-'}</td>
                    <td class="mono text-muted">${formatTime(user.created_at)}</td>
                    <td class="actions">
                        ${user.is_active ? 
                            `<button class="btn-icon" onclick="toggleUser(${user.id}, false)" title="ç¦ç”¨">ğŸš«</button>` :
                            `<button class="btn-icon" onclick="toggleUser(${user.id}, true)" title="å¯ç”¨">âœ…</button>`
                        }
                    </td>
                </tr>
            `).join('');
        }
    } catch (error) {
        console.error('Failed to load users:', error);
        tbody.innerHTML = '<tr><td colspan="9" class="empty-state small"><p>åŠ è½½å¤±è´¥</p></td></tr>';
    }
}

// Toggle user active status
async function toggleUser(userId, active) {
    try {
        const response = await fetch(`/api/admin/users/${userId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ is_active: active })
        });
        
        if (response.ok) {
            showToast(active ? 'ç”¨æˆ·å·²å¯ç”¨' : 'ç”¨æˆ·å·²ç¦ç”¨', 'success');
            loadUsers();
        } else {
            const data = await response.json();
            showToast(data.detail || 'æ“ä½œå¤±è´¥', 'error');
        }
    } catch (error) {
        showToast('æ“ä½œå¤±è´¥', 'error');
    }
}

// Load strategies overview
async function loadStrategies() {
    const tbody = document.getElementById('strategies-tbody');
    tbody.innerHTML = '<tr><td colspan="8" class="loading-state"><p>åŠ è½½ä¸­...</p></td></tr>';
    
    try {
        const response = await fetch('/api/admin/strategies/overview');
        if (response.ok) {
            const data = await response.json();
            const configs = data.configs;
            
            if (configs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state small"><p>æš‚æ— è¿è¡Œä¸­çš„ç­–ç•¥</p></td></tr>';
                return;
            }
            
            tbody.innerHTML = configs.map(config => `
                <tr>
                    <td class="mono">${config.id}</td>
                    <td class="symbol">${config.symbol}</td>
                    <td><span class="badge ${config.side === 'long' ? 'badge-success' : 'badge-danger'}">${config.side}</span></td>
                    <td><span class="status-badge status-${config.status}">${config.status}</span></td>
                    <td class="mono">${config.timeframe}</td>
                    <td class="mono">${config.current_stop ? config.current_stop.toFixed(4) : '-'}</td>
                    <td class="mono text-muted">${config.last_checked ? formatTime(config.last_checked) : '-'}</td>
                    <td class="mono text-muted">${config.updated_at ? formatTime(config.updated_at) : '-'}</td>
                </tr>
            `).join('');
        }
    } catch (error) {
        console.error('Failed to load strategies:', error);
        tbody.innerHTML = '<tr><td colspan="8" class="empty-state small"><p>åŠ è½½å¤±è´¥</p></td></tr>';
    }
}

// Load audit logs
async function loadAuditLogs() {
    const tbody = document.getElementById('audit-tbody');
    const actionFilter = document.getElementById('audit-action-filter').value;
    tbody.innerHTML = '<tr><td colspan="7" class="loading-state"><p>åŠ è½½ä¸­...</p></td></tr>';
    
    try {
        let url = '/api/admin/audit-logs?limit=100';
        if (actionFilter) {
            url += `&action=${actionFilter}`;
        }
        
        const response = await fetch(url);
        if (response.ok) {
            const logs = await response.json();
            
            if (logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state small"><p>æš‚æ— å®¡è®¡æ—¥å¿—</p></td></tr>';
                return;
            }
            
            tbody.innerHTML = logs.map(log => `
                <tr class="${log.success ? '' : 'row-error'}">
                    <td class="mono log-time">${formatTime(log.created_at)}</td>
                    <td class="mono">${log.user_id || '-'}</td>
                    <td><span class="action-badge">${log.action}</span></td>
                    <td>${log.resource_type || '-'}</td>
                    <td class="mono">${log.resource_id || '-'}</td>
                    <td class="mono text-muted">${log.ip_address || '-'}</td>
                    <td><span class="status-dot ${log.success ? 'success' : 'error'}"></span></td>
                </tr>
            `).join('');
        }
    } catch (error) {
        console.error('Failed to load audit logs:', error);
        tbody.innerHTML = '<tr><td colspan="7" class="empty-state small"><p>åŠ è½½å¤±è´¥</p></td></tr>';
    }
}

// Format time helper
function formatTime(isoString) {
    if (!isoString) return '-';
    const date = new Date(isoString);
    return date.toLocaleString('zh-CN', { 
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit', 
        minute: '2-digit'
    });
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadStats();
    loadUsers();
    loadStrategies();
    loadAuditLogs();
    
    // Add filter change listener
    document.getElementById('audit-action-filter').addEventListener('change', loadAuditLogs);
});
</script>
{% endblock %}


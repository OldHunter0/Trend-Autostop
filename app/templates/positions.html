{% extends "base.html" %}

{% block title %}æ™ºèƒ½æ­¢æŸ - Trend-Autostop{% endblock %}

{% block page_title %}æ™ºèƒ½æ­¢æŸ{% endblock %}

{% block content %}
<div class="content-split">
    <!-- Config Form -->
    <section class="card form-card">
        <div class="card-header">
            <h2 id="form-title">å¼€å¯æ™ºèƒ½æ­¢æŸ</h2>
        </div>
        <div class="card-body">
            <form id="config-form" onsubmit="submitConfig(event)">
                <input type="hidden" id="config-id" value="">
                <input type="hidden" id="symbol" name="symbol" value="">
                <input type="hidden" id="side" name="side" value="">
                
                <div class="form-group">
                    <label for="credential_id">APIè´¦æˆ· <span class="required">*</span></label>
                    <select id="credential_id" name="credential_id" required onchange="loadUnmanagedPositions()">
                        <option value="">é€‰æ‹©è´¦æˆ·...</option>
                        {% for cred in credentials %}
                        <option value="{{ cred.id }}">{{ cred.name }} ({{ cred.exchange }})</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="position_select">é€‰æ‹©ä»“ä½ <span class="required">*</span></label>
                    <select id="position_select" name="position_select" required onchange="onPositionSelect()">
                        <option value="">è¯·å…ˆé€‰æ‹©APIè´¦æˆ·...</option>
                    </select>
                    <small>ä»æ‚¨çš„æœªæ‰˜ç®¡ä»“ä½ä¸­é€‰æ‹©</small>
                </div>
                
                <div class="form-divider">
                    <span>ç­–ç•¥å‚æ•°</span>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="timeframe">æ—¶é—´å‘¨æœŸ</label>
                        <select id="timeframe" name="timeframe">
                            {% for tf in timeframes %}
                            <option value="{{ tf }}" {% if tf == '15min' %}selected{% endif %}>{{ tf }}</option>
                            {% endfor %}
                        </select>
                        <small>ç­–ç•¥è®¡ç®—åŸºäºçš„Kçº¿çº§åˆ«</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="sl_offset">SL Offset</label>
                        <input type="number" id="sl_offset" name="sl_offset" value="0" step="0.0001" min="0">
                        <small>é¢å¤–çš„ä»·æ ¼æ­¢æŸåç§»é‡</small>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="delay_bars">ç”Ÿæ•ˆå»¶è¿Ÿ (Kçº¿æ•°)</label>
                    <input type="number" id="delay_bars" name="delay_bars" value="0" min="0">
                    <small>å¼€ä»“åå‰Næ ¹Kçº¿ä¸è°ƒæ•´æ­¢æŸ</small>
                </div>
                
                <details class="advanced-settings">
                    <summary>é«˜çº§å‚æ•° (SuperTrend)</summary>
                    <div class="advanced-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="ema_len">EMA é•¿åº¦</label>
                                <input type="number" id="ema_len" name="ema_len" value="8" min="2">
                            </div>
                            <div class="form-group">
                                <label for="atr_len">ATR é•¿åº¦</label>
                                <input type="number" id="atr_len" name="atr_len" value="14" min="1">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="base_mult">åŸºç¡€ä¹˜æ•°</label>
                                <input type="number" id="base_mult" name="base_mult" value="2.0" step="0.1" min="0.1">
                            </div>
                            <div class="form-group">
                                <label for="vol_lookback">æ³¢åŠ¨å›æº¯æœŸ</label>
                                <input type="number" id="vol_lookback" name="vol_lookback" value="20" min="2">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="trend_lookback">è¶‹åŠ¿å›æº¯æœŸ</label>
                                <input type="number" id="trend_lookback" name="trend_lookback" value="25" min="2">
                            </div>
                            <div class="form-group">
                                <label for="trend_impact">è¶‹åŠ¿å½±å“å› å­</label>
                                <input type="number" id="trend_impact" name="trend_impact" value="0.4" step="0.05" min="0" max="1">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="mult_min">æœ€å°ä¹˜æ•°</label>
                                <input type="number" id="mult_min" name="mult_min" value="1.0" step="0.1" min="0.1">
                            </div>
                            <div class="form-group">
                                <label for="mult_max">æœ€å¤§ä¹˜æ•°</label>
                                <input type="number" id="mult_max" name="mult_max" value="4.0" step="0.1" min="0.5">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="confirm_bars">ç¡®è®¤Kçº¿æ•°</label>
                            <input type="number" id="confirm_bars" name="confirm_bars" value="1" min="1">
                        </div>
                    </div>
                </details>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-ghost" onclick="resetForm()">é‡ç½®</button>
                    <button type="submit" class="btn btn-primary">
                        <span id="submit-text">å¼€å¯æ­¢æŸ</span>
                    </button>
                </div>
            </form>
        </div>
    </section>
    
    <!-- Configs List -->
    <section class="card">
        <div class="card-header">
            <h2>å·²å¼€å¯æ™ºèƒ½æ­¢æŸ</h2>
        </div>
        <div class="card-body">
            {% if configs %}
            <div class="config-list">
                {% for config in configs %}
                <div class="config-card" data-id="{{ config.id }}">
                    <div class="config-header">
                        <span class="config-symbol">{{ config.symbol }}</span>
                        <span class="badge {% if config.side == 'long' %}badge-success{% else %}badge-danger{% endif %}">
                            {{ config.side|upper }}
                        </span>
                        <span class="status-badge status-{{ config.status }}">
                            {{ config.status }}
                        </span>
                    </div>
                    <div class="config-details">
                        <div class="detail-item">
                            <span class="label">å‘¨æœŸ</span>
                            <span class="value">{{ config.timeframe }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">å½“å‰æ­¢æŸ</span>
                            <span class="value mono">
                                {% if config.current_stop_price %}
                                {{ "%.4f"|format(config.current_stop_price) }}
                                {% else %}
                                --
                                {% endif %}
                            </span>
                        </div>
                        <div class="detail-item">
                            <span class="label">Offset</span>
                            <span class="value">{{ config.sl_offset }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">å»¶è¿Ÿ</span>
                            <span class="value">{{ config.bars_since_open }}/{{ config.delay_bars }}</span>
                        </div>
                    </div>
                    <div class="config-actions">
                        <button class="btn btn-sm btn-ghost" onclick="loadConfig({{ config.id }})">ç¼–è¾‘</button>
                        <button class="btn btn-sm btn-ghost" onclick="adjustStop({{ config.id }}, {{ config.current_stop_price or 0 }})">è°ƒæ•´æ­¢æŸ</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteConfig({{ config.id }})">åˆ é™¤</button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-icon">ğŸ›¡ï¸</div>
                <p>æš‚æ— å·²å¼€å¯çš„æ™ºèƒ½æ­¢æŸ</p>
            </div>
            {% endif %}
        </div>
    </section>
</div>

<!-- Adjust Stop Modal -->
<div id="adjust-modal" class="modal-backdrop hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3>æ‰‹åŠ¨è°ƒæ•´æ­¢æŸ</h3>
            <button class="btn-close" onclick="closeModal('adjust-modal')">&times;</button>
        </div>
        <form id="adjust-form" onsubmit="submitAdjust(event)">
            <input type="hidden" id="adjust-config-id">
            <div class="form-group">
                <label for="new_stop_price">æ–°æ­¢æŸä»·æ ¼</label>
                <input type="number" id="new_stop_price" step="0.0001" required>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-ghost" onclick="closeModal('adjust-modal')">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary">ç¡®è®¤è°ƒæ•´</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const configs = {{ configs|tojson|default('[]', true) }};
let unmanagedPositions = [];

async function loadUnmanagedPositions() {
    const credentialId = document.getElementById('credential_id').value;
    const positionSelect = document.getElementById('position_select');
    
    if (!credentialId) {
        positionSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©APIè´¦æˆ·...</option>';
        return;
    }
    
    positionSelect.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';
    
    try {
        const res = await fetch(`/api/credentials/${credentialId}/unmanaged-positions`);
        if (!res.ok) throw new Error('Failed to load positions');
        
        unmanagedPositions = await res.json();
        
        if (unmanagedPositions.length === 0) {
            positionSelect.innerHTML = '<option value="">æš‚æ— æœªæ‰˜ç®¡ä»“ä½</option>';
        } else {
            positionSelect.innerHTML = '<option value="">é€‰æ‹©ä»“ä½...</option>';
            unmanagedPositions.forEach((pos, idx) => {
                const pnlClass = pos.unrealized_pnl >= 0 ? 'ç›ˆåˆ©' : 'äºæŸ';
                const sideText = pos.side === 'long' ? 'åšå¤š' : 'åšç©º';
                positionSelect.innerHTML += `<option value="${idx}">${pos.symbol} | ${sideText} | ${pos.size} | ${pnlClass}: ${pos.unrealized_pnl.toFixed(2)} USDT</option>`;
            });
        }
    } catch (err) {
        positionSelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</option>';
        showToast('åŠ è½½ä»“ä½å¤±è´¥: ' + err.message, 'error');
    }
}

function onPositionSelect() {
    const idx = document.getElementById('position_select').value;
    if (idx === '' || !unmanagedPositions[idx]) return;
    
    const pos = unmanagedPositions[idx];
    document.getElementById('symbol').value = pos.symbol;
    document.getElementById('side').value = pos.side;
}

async function submitConfig(e) {
    e.preventDefault();
    const form = e.target;
    const configId = document.getElementById('config-id').value;
    
    const symbol = document.getElementById('symbol').value;
    const side = document.getElementById('side').value;
    
    if (!configId && (!symbol || !side)) {
        showToast('è¯·é€‰æ‹©ä¸€ä¸ªä»“ä½', 'error');
        return;
    }
    
    const data = {
        symbol: symbol,
        side: side,
        credential_id: parseInt(form.credential_id.value),
        timeframe: form.timeframe.value,
        sl_offset: parseFloat(form.sl_offset.value),
        delay_bars: parseInt(form.delay_bars.value),
        ema_len: parseInt(form.ema_len.value),
        atr_len: parseInt(form.atr_len.value),
        base_mult: parseFloat(form.base_mult.value),
        vol_lookback: parseInt(form.vol_lookback.value),
        trend_lookback: parseInt(form.trend_lookback.value),
        trend_impact: parseFloat(form.trend_impact.value),
        mult_min: parseFloat(form.mult_min.value),
        mult_max: parseFloat(form.mult_max.value),
        confirm_bars: parseInt(form.confirm_bars.value)
    };
    
    try {
        const url = configId ? `/api/configs/${configId}` : '/api/configs';
        const method = configId ? 'PATCH' : 'POST';
        
        const res = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (!res.ok) throw new Error('Failed to save');
        
        showToast(configId ? 'é…ç½®å·²æ›´æ–°' : 'æ™ºèƒ½æ­¢æŸå·²å¼€å¯', 'success');
        location.reload();
    } catch (err) {
        showToast('ä¿å­˜å¤±è´¥: ' + err.message, 'error');
    }
}

function loadConfig(id) {
    const config = configs.find(c => c.id === id);
    if (!config) return;
    
    document.getElementById('config-id').value = config.id;
    document.getElementById('form-title').textContent = 'ç¼–è¾‘æ™ºèƒ½æ­¢æŸ';
    document.getElementById('submit-text').textContent = 'ä¿å­˜ä¿®æ”¹';
    
    document.getElementById('symbol').value = config.symbol;
    document.getElementById('side').value = config.side;
    document.getElementById('credential_id').value = config.credential_id;
    
    // ç¼–è¾‘æ¨¡å¼ä¸‹ï¼Œç¦ç”¨ä»“ä½é€‰æ‹©å¹¶æ˜¾ç¤ºå½“å‰ä»“ä½ä¿¡æ¯
    const positionSelect = document.getElementById('position_select');
    const sideText = config.side === 'long' ? 'åšå¤š' : 'åšç©º';
    positionSelect.innerHTML = `<option value="current">${config.symbol} | ${sideText} (å½“å‰æ‰˜ç®¡)</option>`;
    positionSelect.disabled = true;
    
    document.getElementById('timeframe').value = config.timeframe;
    document.getElementById('sl_offset').value = config.sl_offset;
    document.getElementById('delay_bars').value = config.delay_bars;
    document.getElementById('ema_len').value = config.ema_len;
    document.getElementById('atr_len').value = config.atr_len;
    document.getElementById('base_mult').value = config.base_mult;
    document.getElementById('vol_lookback').value = config.vol_lookback;
    document.getElementById('trend_lookback').value = config.trend_lookback;
    document.getElementById('trend_impact').value = config.trend_impact;
    document.getElementById('mult_min').value = config.mult_min;
    document.getElementById('mult_max').value = config.mult_max;
    document.getElementById('confirm_bars').value = config.confirm_bars;
    
    // Scroll to form
    document.querySelector('.form-card').scrollIntoView({ behavior: 'smooth' });
}

function resetForm() {
    document.getElementById('config-form').reset();
    document.getElementById('config-id').value = '';
    document.getElementById('symbol').value = '';
    document.getElementById('side').value = '';
    document.getElementById('form-title').textContent = 'å¼€å¯æ™ºèƒ½æ­¢æŸ';
    document.getElementById('submit-text').textContent = 'å¼€å¯æ­¢æŸ';
    document.getElementById('position_select').disabled = false;
    document.getElementById('position_select').innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©APIè´¦æˆ·...</option>';
}

function adjustStop(configId, currentPrice) {
    document.getElementById('adjust-config-id').value = configId;
    document.getElementById('new_stop_price').value = currentPrice || '';
    document.getElementById('adjust-modal').classList.remove('hidden');
}

function closeModal(id) {
    document.getElementById(id).classList.add('hidden');
}

async function submitAdjust(e) {
    e.preventDefault();
    const configId = document.getElementById('adjust-config-id').value;
    const newPrice = parseFloat(document.getElementById('new_stop_price').value);
    
    try {
        const res = await fetch(`/api/configs/${configId}/adjust-stop`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ new_stop_price: newPrice })
        });
        
        if (!res.ok) throw new Error('Failed to adjust');
        
        showToast('æ­¢æŸå·²è°ƒæ•´', 'success');
        closeModal('adjust-modal');
        location.reload();
    } catch (err) {
        showToast('è°ƒæ•´å¤±è´¥: ' + err.message, 'error');
    }
}

async function deleteConfig(id) {
    if (!confirm('ç¡®å®šåˆ é™¤æ­¤æ‰˜ç®¡é…ç½®ï¼Ÿ')) return;
    
    try {
        await fetch(`/api/configs/${id}`, { method: 'DELETE' });
        showToast('é…ç½®å·²åˆ é™¤', 'success');
        location.reload();
    } catch (err) {
        showToast('åˆ é™¤å¤±è´¥', 'error');
    }
}

// Check URL params for edit mode or prefill
const urlParams = new URLSearchParams(window.location.search);
const editId = urlParams.get('edit');
const prefillSymbol = urlParams.get('symbol');
const prefillSide = urlParams.get('side');
const prefillCredentialId = urlParams.get('credential_id');

if (editId) {
    loadConfig(parseInt(editId));
} else if (prefillSymbol && prefillSide && prefillCredentialId) {
    // Prefill from URL (from dashboard unmanaged positions)
    document.getElementById('symbol').value = prefillSymbol;
    document.getElementById('side').value = prefillSide;
    document.getElementById('credential_id').value = prefillCredentialId;
    
    const sideText = prefillSide === 'long' ? 'åšå¤š' : 'åšç©º';
    const positionSelect = document.getElementById('position_select');
    positionSelect.innerHTML = `<option value="prefilled" selected>${prefillSymbol} | ${sideText}</option>`;
}
</script>
{% endblock %}


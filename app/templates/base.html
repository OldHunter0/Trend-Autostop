<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Trend-Autostop{% endblock %}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
    {% block extra_css %}{% endblock %}
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <span class="logo-icon">ğŸ“ˆ</span>
                    <span class="logo-text">Trend<span class="accent">Stop</span></span>
                </div>
            </div>
            
            <ul class="nav-menu">
                <li class="nav-item {% if request.url.path == '/' %}active{% endif %}">
                    <a href="/" class="nav-link">
                        <span class="nav-icon">ğŸ¯</span>
                        <span>ä»ªè¡¨ç›˜</span>
                    </a>
                </li>
                <li class="nav-item {% if request.url.path == '/strategies' %}active{% endif %}">
                    <a href="/strategies" class="nav-link">
                        <span class="nav-icon">ğŸ“Š</span>
                        <span>è·Ÿéšç­–ç•¥</span>
                    </a>
                </li>
                <li class="nav-item {% if request.url.path == '/positions' %}active{% endif %}">
                    <a href="/positions" class="nav-link">
                        <span class="nav-icon">ğŸ›¡ï¸</span>
                        <span>æ™ºèƒ½æ­¢æŸ</span>
                    </a>
                </li>
                <li class="nav-item {% if request.url.path == '/logs' %}active{% endif %}">
                    <a href="/logs" class="nav-link">
                        <span class="nav-icon">ğŸ“‹</span>
                        <span>æ“ä½œæ—¥å¿—</span>
                    </a>
                </li>
                <li class="nav-item {% if request.url.path == '/settings' %}active{% endif %}">
                    <a href="/settings" class="nav-link">
                        <span class="nav-icon">âš™ï¸</span>
                        <span>è®¾ç½®</span>
                    </a>
                </li>
                {% if user and user.is_admin() %}
                <li class="nav-item {% if request.url.path == '/admin' %}active{% endif %}">
                    <a href="/admin" class="nav-link">
                        <span class="nav-icon">ğŸ”</span>
                        <span>ç®¡ç†åå°</span>
                    </a>
                </li>
                {% endif %}
            </ul>
            
            <div class="sidebar-footer">
                <div class="status-indicator">
                    <span class="status-dot"></span>
                    <span>ç³»ç»Ÿè¿è¡Œä¸­</span>
                </div>
                {% if user %}
                <div class="user-menu">
                    <div class="user-info">
                        <span class="user-avatar">{{ user.email[0]|upper }}</span>
                        <span class="user-email">{{ user.email }}</span>
                    </div>
                    <button onclick="logout()" class="logout-btn" title="é€€å‡ºç™»å½•">ğŸšª</button>
                </div>
                {% endif %}
            </div>
        </nav>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Email Verification Banner -->
            {% if user and not user.is_email_verified %}
            <div class="email-verify-banner" id="email-verify-banner">
                <div class="verify-banner-content">
                    <span class="verify-icon">ğŸ“§</span>
                    <span class="verify-text">æ‚¨çš„é‚®ç®±å°šæœªéªŒè¯ï¼Œéƒ¨åˆ†åŠŸèƒ½å°†å—é™ã€‚è¯·æ£€æŸ¥ <strong>{{ user.email }}</strong> çš„æ”¶ä»¶ç®±å¹¶å®ŒæˆéªŒè¯ã€‚</span>
                </div>
                <div class="verify-banner-actions">
                    <button onclick="resendVerificationEmail()" class="verify-resend-btn" id="resend-btn">
                        é‡æ–°å‘é€éªŒè¯é‚®ä»¶
                    </button>
                    <button onclick="dismissBanner()" class="verify-dismiss-btn" title="æš‚æ—¶å…³é—­">âœ•</button>
                </div>
            </div>
            {% endif %}
            
            <header class="page-header">
                <h1 class="page-title">{% block page_title %}Dashboard{% endblock %}</h1>
                <div class="header-actions">
                    {% block header_actions %}{% endblock %}
                </div>
            </header>
            
            <div class="content-wrapper {% if user and not user.is_email_verified %}content-restricted{% endif %}">
                {% block content %}{% endblock %}
            </div>
        </main>
    </div>
    
    <!-- Toast Container -->
    <div id="toast-container"></div>
    
    <!-- Modal Container -->
    <div id="modal-backdrop" class="modal-backdrop hidden">
        <div id="modal-content" class="modal-content">
            <!-- Modal content injected by JS -->
        </div>
    </div>
    
    <script src="/static/js/app.js"></script>
    <script>
        async function logout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
            } catch (e) {
                console.error('Logout error:', e);
            }
            window.location.href = '/auth/login';
        }
        
        async function resendVerificationEmail() {
            const btn = document.getElementById('resend-btn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'å‘é€ä¸­...';
            
            try {
                const response = await fetch('/api/auth/resend-verification', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: '{{ user.email if user else "" }}' })
                });
                
                if (response.ok) {
                    btn.textContent = 'å·²å‘é€ âœ“';
                    btn.classList.add('sent');
                    if (typeof showToast === 'function') {
                        showToast('éªŒè¯é‚®ä»¶å·²å‘é€ï¼Œè¯·æ£€æŸ¥æ”¶ä»¶ç®±', 'success');
                    }
                    // 60ç§’åæ¢å¤æŒ‰é’®
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.textContent = originalText;
                        btn.classList.remove('sent');
                    }, 60000);
                } else {
                    const data = await response.json();
                    btn.textContent = originalText;
                    btn.disabled = false;
                    if (typeof showToast === 'function') {
                        showToast(data.detail || 'å‘é€å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                    }
                }
            } catch (e) {
                console.error('Resend error:', e);
                btn.textContent = originalText;
                btn.disabled = false;
                if (typeof showToast === 'function') {
                    showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
                }
            }
        }
        
        function dismissBanner() {
            const banner = document.getElementById('email-verify-banner');
            if (banner) {
                banner.style.display = 'none';
                // ä¿å­˜åˆ° sessionStorageï¼Œåˆ·æ–°é¡µé¢åä¼šé‡æ–°æ˜¾ç¤º
                sessionStorage.setItem('email-banner-dismissed', 'true');
            }
        }
        
        // æ£€æŸ¥æ˜¯å¦å·²æš‚æ—¶å…³é—­æé†’
        document.addEventListener('DOMContentLoaded', function() {
            if (sessionStorage.getItem('email-banner-dismissed') === 'true') {
                const banner = document.getElementById('email-verify-banner');
                if (banner) banner.style.display = 'none';
            }
        });
    </script>
    {% block extra_js %}{% endblock %}
</body>
</html>

